---
layout: post
title:  "1week 스터디"
categories: [java]
tags: java, jvm, jit
last_modified_at: 2021-03-29
---

# 제목입니다.

- 목차1
- 목차2
- 목차3

| 항목 | 1    | 2    | 3       |      |      |
| ---- | ---- | ---- | :------ | ---- | ---- |
| 0    | 0    | 0    | 0dddddd |      |      |
| 0    | 0    | 0    | 0       |      |      |
| 0    | 0    | 0    | 0       |      |      |
| 0    | 0    | 0    | 0       |      |      |
| 0    | 0    | 0    | 0       |      |      |

```java
package com.sk.v2.buy.Controller;

@Controller
@RequestMapping("/v2/afterBuy/")
public class AfterBuyController {
	
	private static final Logger serviceLog = LogUtil.serviceLog; // 서비스 로그
	
	@Autowired
	private BuyService buyService; 
	
	@Autowired
	private BuyServiceV2 buyServiceV2; 
	
	@Autowired
	private BuyUtils buyUtils;
	
	@Autowired
	private StockCountUtil stockCountUtil;
	
	@Autowired
	private InicisUtil inicisUtil;
	
	 //단건 이니시스 연동 키
	@Value("#{comm['pay.inipay.mid']}")
	private String singleInicisKey;	
	
	// 다건 이니시스 연동 키
	@Value("#{comm['pay.inipay.billing.mid']}")
	private String periodInicisKey;
	

	//mid 비밀번호(multi)
	@Value("#{comm['pay.inipay.billing.keyPW']}")
	private  String keyBillingPW;
	
	@RequestMapping(value="singleBuyReturn")  
	public String singleBuyReturn(@RequestParam(value="P_STATUS", required=false) String status
			 , @RequestParam(value="P_NOTI", required=true) String noti 
			 , @RequestParam(value="P_RMESG1", required=false) String msg 
			 , HttpServletRequest request
			 , Model model
			 , HttpServletResponse response) throws Exception {
		
		serviceLog.info("유료 단건 결과 페이지 시작");
		serviceLog.info("P_STATUS : "+ status);
		serviceLog.info("P_NOTI : " + noti);
		serviceLog.info("P_RMESG1 : "  + msg);
		
		if(!StringUtils.equals(Constants.INICIS_SUCCESS, status)) {
			
			serviceLog.info("1. 이니시스에서 실패를 제공함(해당 경우에는 주문 번호(buyNum)를 제공하지 않아서 DB 데이터를 알 수 없음)");
			// PG사 단건 결제 인증 실패 시
			BuyBo buyBo = new BuyBo();
			serviceLog.error("[이니시스 결제 실패] / " + MDC.get("traceId") + "/ P_STATUS :" + status + "/P_RMESG1 : " + msg);
			
			buyBo.setBuyFailReason("[이니시스 결제 실패] / " + MDC.get("traceId") + "/ P_STATUS :" + status + "/P_RMESG1 : " + msg);
			buyBo.setBuyType(buyType.BT001.code);
			if(!StringUtils.equals("01", status)) {
				serviceLog.info("2. 사용자 취소 이외에는 DB에 저장");
				buyService.registerBuyFail(buyBo);
			}
			
			return alertResultSingleMessage(model, status);
			
		} else {
			serviceLog.info("1. 이니시스에서 정상적으로 데이터 제공");
			
			if(null == request.getParameter("P_REQ_URL"))  {
				serviceLog.error("P_REQ_URL 변수 존재하지 않음");
				throw new WebViewRedirectException(AlertMessage.ERR_ETC);
			} else if (null == request.getParameter("P_TID")) {
				serviceLog.error("P_TID 변수 존재하지 않음");
				throw new WebViewRedirectException(AlertMessage.ERR_ETC);
			}
			
			String reqUrl = request.getParameter("P_REQ_URL");
			
			 // 이니시스 연동
		     Map<String, Object> body = new HashMap<String, Object>();
			  
			 body.put("P_TID",  request.getParameter("P_TID"));
			 body.put("P_MID", singleInicisKey);
			  
			 serviceLog.info("1. 이니시스 단건 결제 시작-중간 연동");
			 serviceLog.info("url : " + reqUrl);
			 serviceLog.info("param : " + body.toString());
			
			 HttpClientUtil httpClient = new HttpClientUtil();
			 httpClient.setDefaultValue(reqUrl, "", HttpMethod.GET, null, body, null, Constants.CHARSET_UTF8); 
			 
			 try {
				 String result = "";
				 
				 serviceLog.info("2. 이니시스 단건 결제 실걸제 요청");
				 result = httpClient.excute(); // 이니시스 실 결제 요청
				  serviceLog.info("이니시스 결제 결과 : " + result);
				 
				 if(!StringUtils.isBlank(result)) {
					  serviceLog.info("이니시스 실결제 진행 후 결과값 분석 시작");
					  Map<String, Object> map = inicisUtil.inicisResult(result, "&");
					  
					  String resultStatus = (String)map.get("P_STATUS");
					  
					  if(!StringUtils.equals(Constants.INICIS_SUCCESS, resultStatus)) {
						serviceLog.info("이니시스 실 결제 이후 결제 실패를 제공한 경우");
						String buyNum = (String)map.get("P_OID");
						String authTid =(String)map.get("P_TID"); 
						
					  // 임시 테이블에서 데이터 가져옴
						serviceLog.info("임시 데이터를 가져옴");
						BuyBo buyBo = new BuyBo();
						buyBo = buyService.selectTempBuyInfo(buyNum);
					  
						if(buyBo == null) {
							buyBo = new BuyBo();
							buyBo.setBuyFailReason("[이니시스 결제 실패] 임시 데이터 존재하지 않음 / " + MDC.get("traceId") + "/ P_STATUS :" + resultStatus + "/P_RMESG1 : " + result);
							serviceLog.error("[이니시스 결제 실패] 임시 데이터 존재하지 않음 / " + MDC.get("traceId") + "/ P_STATUS :" + resultStatus + "/P_RMESG1 : " + result);
							buyBo.setBuyType(buyType.BT001.code);
							// 1. 이니시스 취소 요청
							buyBo.setBuyAuthTid(authTid);
							   
							serviceLog.info("결제 취소 진행");
							inicisUtil.getInicisCancelPay(buyBo, request, true); // 이니시스 결제 취소 실행
							 
							// 2. 임시 테이블에 입력
							buyService.registerBuyFail(buyBo);
							throw new WebViewRedirectException(AlertMessage.ERR_ETC);
							
						} else {
							
							serviceLog.error("[이니시스 결제 실패] / " + MDC.get("traceId") + "/ P_STATUS :" + resultStatus + "/P_RMESG1 : " + result+  "/ buyNum : " + buyBo.getBuyNum() + ", utilzNum : " + buyBo.getUtilzNum() +", buyTid : " + buyBo.getBuyTid()+ ", buyId : " + buyBo.getBuyId() );	
							buyBo.setBuyFailReason("[이니시스 결제 실패] / " + MDC.get("traceId") + "/ P_STATUS :" + status + "/P_RMESG1 : " + result+  "/ buyNum : " + buyBo.getBuyNum() + ", utilzNum : " + buyBo.getUtilzNum() +", buyTid : " + buyBo.getBuyTid()+ ", buyId : " + buyBo.getBuyId() );
							buyBo.setBuyType(buyType.BT001.code);
							buyService.registerBuyFail(buyBo);
							
							model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
							return "buy/v2/error";
						}					  
					 } else {
						   serviceLog.info("이니시스 실 결제 이후 결제 성공을 제공한 경우");
						   String buyNum = (String)map.get("P_OID");
						   String authTid =(String)map.get("P_TID"); 
						   
						   BuyBo buyBo = new BuyBo();
						   buyBo = buyService.selectTempBuyInfo(buyNum);
						   
						   if(buyBo == null) {
							   serviceLog.info("임시 테이블에 해당 데이터가 존재하지 않음");
							   
							   int payPrice = 0;
							   payPrice  = Integer.parseInt((String)map.get("P_AMT"));
							   buyBo.setBuyAuthTid(authTid);
							   
							   serviceLog.info("결제 취소 진행");
							   inicisUtil.getInicisCancelPay(buyBo, request, true); // 이니시스 결제 취소 실행
								
							   serviceLog.info("실패 테이블에 해당 내용 저장");
							    buyBo = new BuyBo();
								buyBo.setBuyFailReason("[이니시스 결제 실패] 임시 데이터 존재하지 않음 / " + MDC.get("traceId") + "/ P_STATUS :" + resultStatus + "/P_RMESG1 : " + msg);
								serviceLog.error("[이니시스 결제 실패] 임시 데이터 존재하지 않음 / " + MDC.get("traceId") + "/ P_STATUS :" + resultStatus + "/P_RMESG1 : " + msg);
								buyBo.setBuyType(buyType.BT001.code);
								buyService.registerBuyFail(buyBo);
								throw new WebViewRedirectException(AlertMessage.ERR_ETC);
						   } 
						  serviceLog.info("임시 테이블에 해당 데이터가 존재");
						  //  norang 임시테이블 결제금액과 실결제금액 비교 P_AMT
						  serviceLog.info("임시 테이블 결제금액 : 이니시스 실 결제금액 비교");
						  buyBo.setBuyAuthTid(authTid);
						  if(Integer.parseInt((String)map.get("P_AMT")) != buyBo.getPayPrice()){
							serviceLog.info("임시 테이블 결제금액과 실 결제금액 불일치");
							serviceLog.info("결제 취소 진행");
							inicisUtil.getInicisCancelPay(buyBo, request, true); // 이니시스 결제 취소 실행
							serviceLog.info("실패 테이블에 해당 내용 저장");
							buyBo.setBuyFailReason("[이니시스 결제 실패] 임시 테이블 결제금액과 실 결제금액 불일치 / " + MDC.get("traceId") + "/ P_STATUS :" + resultStatus + "/P_RMESG1 : " + msg);
							serviceLog.error("[이니시스 결제 실패] 임시 테이블 결제금액과 실 결제금액 불일치 / " + MDC.get("traceId") + "/ P_STATUS :" + resultStatus + "/P_RMESG1 : " + msg);
							buyBo.setBuyType(buyType.BT001.code);
							buyService.registerBuyFail(buyBo);
							throw new WebViewRedirectException(AlertMessage.ERR_ETC);
						  }
						  serviceLog.info("임시 테이블 결제금액과 실 결제금액 일치");
						  serviceLog.info("1. 이니시스에서 받아온 값 설정");
						 // 이니시스에서 받아온 값 설정
						  buyBo.setBuyAuthTid(authTid);
						  buyBo.setPayPrice(Integer.parseInt((String)map.get("P_AMT")));;
						  buyBo.setBuyAuthNum((String)map.get("P_AUTH_NO"));
						  buyBo.setPayDay((String)map.get("P_AUTH_DT"));
						  buyBo.setFirstBuyNum(Long.parseLong(buyNum));
						  
						  buyBo.setPayResult(true);
						  buyBo.setResultMessage((String)map.get("P_RMESG1"));
						  buyBo.setPayOption(CommonCode.pmmCode.CARD.code);
						  
							serviceLog.info("2. 재고 감소");
							if(stockCountUtil.decreaseUtilzStock(buyBo.getUtilzNum())) {
								
								serviceLog.info("3. 재고 감소 성공");
								serviceLog.info("4. 단건 이용권 등록");
								
								buyBo.setAppVersion(20);
								buyBo = buyService.getSingleBuy(buyBo,request);
								
								if(buyBo.getResultPayCount() < 1) {
									serviceLog.info("5. 단건 이용권 등록 실패-재고 수량 증가 처리");
									
									serviceLog.info("결제 취소 진행");
									 inicisUtil.getInicisCancelPay(buyBo, request, true); // 이니시스 결제 취소 실행
									
									stockCountUtil.increaseUtilzStock(buyBo.getUtilzNum());   //  재고 수량 증가
									buyBo.setBuyType(buyType.BT001.code);
									buyService.registerBuyFail(buyBo);
									model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
									return "buy/v2/error"; 
									
								} else {
									
									serviceLog.info("5. 단건 이용권 등록 성공");
									String appResult = "";
									String url = "";
									
									 if(StringUtils.equals("Y",  buyBo.getDiscountApplyYN())) {
										 appResult = "이벤트 이용권이 지급되었습니다.";
									  } else { 
										  appResult = "결제가 완료되었습니다.";
									  }
									
									if(StringUtils.equals(CommonCode.ppcCode.AUDIUN.code, buyBo.getUtilzAgent())) {
										url = UrlConfig.appAudienHomeSchem;
									} else  if (StringUtils.equals(CommonCode.ppcCode.MELON.code, buyBo.getUtilzAgent())) {
										url = UrlConfig.appMelonHomeSchem;
									}  else  if (StringUtils.equals(CommonCode.ppcCode.MUSICMATE.code, buyBo.getUtilzAgent())) {
										url = UrlConfig.appMusicmateHomeSchem;
									} else  if (StringUtils.equals(CommonCode.ppcCode.BUGS.code, buyBo.getUtilzAgent())) {
										url = UrlConfig.appBugsHomeSchem;
									} else  if (StringUtils.equals(CommonCode.ppcCode.EVERYSING.code, buyBo.getUtilzAgent())) {
										url = UrlConfig.appEverysingHomeSchem;
									} else  if (StringUtils.equals(CommonCode.ppcCode.KUMYOUNG.code, buyBo.getUtilzAgent())) {
										url = UrlConfig.appKumyoungHomeSchem;
									} else  if (StringUtils.equals(CommonCode.ppcCode.OPAL.code, buyBo.getUtilzAgent())) {
										appResult = "이제 NUGU opal을 이용하실 수 있습니다.<br/>선택하신 디바이스로 홈컨텐츠와 메뉴가 변경됩니다.";
										url = UrlConfig.appOpalHomeSchem+buyBo.getNuguDeviceSerialNum();
									} else  if (StringUtils.equals(CommonCode.ppcCode.CELEB_VOICE.code, buyBo.getUtilzAgent())) {
										appResult = "결제가 완료되었습니다.<br/>‘서비스 이용하기’를 눌러 셀럽의 목소리로 설정해보세요.";
										url = UrlConfig.appCelebVoiceHomeSchem+buyBo.getNuguDeviceSerialNum();
									} else  if (StringUtils.equals(CommonCode.ppcCode.CELEB_ALARM.code, buyBo.getUtilzAgent())) {
										appResult = "결제가 완료되었습니다.<br/>‘서비스 이용하기’를 눌러 셀럽의 목소리로 알람을 설정해보세요.";
										url = UrlConfig.appCelebAlarmHomeSchem;
									}
									model.addAttribute("utilzAgent", buyBo.getUtilzAgent());
									model.addAttribute("msg", appResult);
									model.addAttribute("redirectionUrl", url);
									serviceLog.info("결과 : msg - " + appResult + "/redirectionUrl : " + url);
									return "buy/v2/result"; 
								}
								
							} else {
								serviceLog.info("2. 재고 감소 실패");
								
								 serviceLog.info("결제 취소 진행");
								 inicisUtil.getInicisCancelPay(buyBo, request, true); // 이니시스 결제 취소 실행
								
								 buyBo.setBuyFailReason("[단건결제 재고 감소 실패] / " + MDC.get("traceId") 
								 + "/ buyNum : " + buyBo.getBuyNum() + ", utilzNum : " + buyBo.getUtilzNum() 
								 +", buyTid : " + buyBo.getBuyTid()+ ", buyId : " + buyBo.getBuyId() );
								 buyBo.setBuyType(buyType.BT001.code);
								 buyService.registerBuyFail(buyBo);
								 model.addAttribute("msg",  AlertMessage.ERR_PAY_P15.resultMessage);
								 return "buy/v2/error"; 
							}							  
					  }
					} else {
					 serviceLog.error("이니시스 실 결제 요청 시, reponse에 빈값 제공");
					 throw new WebViewRedirectException(AlertMessage.ERR_ETC);
				 }
			 } catch (Exception e) {
				serviceLog.error("이니시스 단건 결제 실결제시 에러 발생 : " + e.getMessage());
				throw new WebViewRedirectException(AlertMessage.ERR_ETC);
			 }
		}
	}
	
	
	
	
	@RequestMapping(value="singleFreeBuyReturn", method=RequestMethod.POST) 
	public String singleFreeBuyReturn(@RequestParam(value="P_NOTI", required=true) String noti
			 ,@RequestParam(value="P_OID", required=false) String buyNum
			 ,@RequestParam(value="P_AMT", required=false) int payPrice
			 ,HttpServletRequest request
			 ,HttpServletResponse response
			 ,Model model) throws Exception {
		
		 if((request.getParameter("P_NOTI") == null)||(request.getParameter("P_OID") == null)||(request.getParameter("P_AMT") == null)) {
			 serviceLog.error("필수 변수가 존재하지 않음");
			throw new WebViewRedirectException(AlertMessage.ERR_ETC);
		 }

		if(payPrice > 0) {
			serviceLog.error("무료 상품 페이지인데 금액이 들어옴 : " + payPrice );
			throw new WebViewRedirectException(AlertMessage.ERR_ETC);
		} else {
			
			BuyBo buyBo = new BuyBo();
			
			buyBo = buyService.selectTempBuyInfo(buyNum);
			
			if(buyBo == null) {
				
				buyBo = new BuyBo();
				
				serviceLog.error("[이니시스 결제 실패] 임시 테이블에 존재하지 않음");
				buyBo.setBuyFailReason("[이니시스 결제 실패] 임시 테이블에 존재하지 않음 ");
				buyBo.setBuyType(buyType.BT002.code);
				buyService.registerBuyFail(buyBo);
				 
				throw new WebViewRedirectException(AlertMessage.ERR_ETC);
				
			} else {
				// 임시테이블 결제금액이 0원이 맞는지 확인 필요
				serviceLog.info("임시 테이블 결제금액과 0원 확인");
				if(buyBo.getPayPrice() != 0){
					serviceLog.error("[이니시스 결제 실패] 임시 테이블 결제금액과 실 결제금액 불일치");
					buyBo.setBuyFailReason("[이니시스 결제 실패] 임시 테이블 결제금액과 실 결제금액 불일치 ");
					buyBo.setBuyType(buyType.BT002.code);
					buyService.registerBuyFail(buyBo);
					 
					throw new WebViewRedirectException(AlertMessage.ERR_ETC);
				}else{
					// 중복결제여부 확인 [ 기프로모션 여부 조회 ]
					serviceLog.info("[중복 결제 확인] 해당 결제 건 프로모션 구매 여부 조회");
					if(StringUtils.equals(CommonCode.ppcCode.MELON.code, buyBo.getUtilzAgent())) {
						serviceLog.info("[중복 결제 확인] 멜론일 경우 빌링키 여부 확인");
						buyBo = buyUtils.isMelonNonBillingKeyBuyerPromotionCheck(buyBo);
					} else {
						buyBo.setMelonNonBillingKeyYN("N");
					}
					if(buyUtils.selectPromotionDeviceCnt(buyBo)) {
						serviceLog.info("[중복 결제 확인] 이미 해당 프로모션 할인 사용");						
						serviceLog.error("[중복 결제 확인] 프로모션 이용권 중복결제로 인한 결제 실패 처리");
						buyBo.setBuyType(CommonCode.buyType.BT002.code);
						buyBo.setBuyFailReason("프로모션 이용권(0원상품) 중복결제로 인한 결제 실패 처리");
						buyService.registerBuyFail(buyBo);
						
						model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
						return "buy/v2/error"; 
					}
					serviceLog.info("[중복 결제 확인] 해당 프로모션 미사용");
				}
				serviceLog.info("임시 테이블 결제금액과 0원 일치");
				serviceLog.info("무료 이용권 등록 시작");
				buyBo.setPayPrice(payPrice);
				buyBo.setPayDay(DateFormatUtils.getDateFormat("yyyyMMddHHmmss"));
				buyBo.setPayOption(CommonCode.pmmCode.FREE.code);
				
				serviceLog.info("1. 재고 감소");
				if(stockCountUtil.decreaseUtilzStock(buyBo.getUtilzNum())) {
					
					serviceLog.info("2. 재고 감소 성공");
					serviceLog.info("3. 단건 이용권 등록");
					buyBo.setAppVersion(20);
					buyBo = buyService.getSingleBuy(buyBo,request);
					
					if(buyBo.getResultPayCount() < 1) {
						serviceLog.info("4. 단건 이용권 등록 실패-재고 수량 증가 처리");
						
						stockCountUtil.increaseUtilzStock(buyBo.getUtilzNum());   //  재고 수량 증가
						buyBo.setBuyType(buyType.BT001.code);
						buyService.registerBuyFail(buyBo);
						model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
						return "buy/v2/error"; 
						
					} else {
						
						serviceLog.info("4. 단건 이용권 등록 성공");
						String msg = "이벤트 이용권이 지급되었습니다.";
						String url = "";
						
						if(StringUtils.equals(CommonCode.ppcCode.AUDIUN.code, buyBo.getUtilzAgent())) {
							url = UrlConfig.appAudienHomeSchem;
						} else  if (StringUtils.equals(CommonCode.ppcCode.MELON.code, buyBo.getUtilzAgent())) {
							url = UrlConfig.appMelonHomeSchem;
						}  else  if (StringUtils.equals(CommonCode.ppcCode.MUSICMATE.code, buyBo.getUtilzAgent())) {
							url = UrlConfig.appMusicmateHomeSchem;
						} else  if (StringUtils.equals(CommonCode.ppcCode.BUGS.code, buyBo.getUtilzAgent())) {
							url = UrlConfig.appBugsHomeSchem;
						} else  if (StringUtils.equals(CommonCode.ppcCode.EVERYSING.code, buyBo.getUtilzAgent())) {
							url = UrlConfig.appEverysingHomeSchem;
						} else  if (StringUtils.equals(CommonCode.ppcCode.KUMYOUNG.code, buyBo.getUtilzAgent())) {
							url = UrlConfig.appKumyoungHomeSchem;
						} else  if (StringUtils.equals(CommonCode.ppcCode.OPAL.code, buyBo.getUtilzAgent())) {
							msg = "이제 NUGU opal을 이용하실 수 있습니다.<br/>선택하신 디바이스로 홈컨텐츠와 메뉴가 변경됩니다.";
							url = UrlConfig.appOpalHomeSchem+buyBo.getNuguDeviceSerialNum();
						} else  if (StringUtils.equals(CommonCode.ppcCode.CELEB_VOICE.code, buyBo.getUtilzAgent())) {
							msg = "결제가 완료되었습니다.<br/>‘서비스 이용하기’를 눌러 셀럽의 목소리로 설정해보세요.";
							url = UrlConfig.appCelebVoiceHomeSchem+buyBo.getNuguDeviceSerialNum();
						} else  if (StringUtils.equals(CommonCode.ppcCode.CELEB_ALARM.code, buyBo.getUtilzAgent())) {
							msg = "결제가 완료되었습니다.<br/>‘서비스 이용하기’를 눌러 셀럽의 목소리로 알람을 설정해보세요.";
							url = UrlConfig.appCelebAlarmHomeSchem;
						}
						model.addAttribute("utilzAgent", buyBo.getUtilzAgent());
						model.addAttribute("msg", msg);
						model.addAttribute("redirectionUrl", url);
						serviceLog.info("결과 : msg - " + msg + "/redirectionUrl : " + url);
						return "buy/v2/result"; 
					}
					
				} else {
					serviceLog.info("2. 재고 감소 실패");
					
					 buyBo.setBuyFailReason("[단건결제 재고 감소 실패] / " + MDC.get("traceId") 
					 + "/ buyNum : " + buyBo.getBuyNum() + ", utilzNum : " + buyBo.getUtilzNum() 
					 +", buyTid : " + buyBo.getBuyTid()+ ", buyId : " + buyBo.getBuyId() );
					 buyBo.setBuyType(buyType.BT001.code);
					 buyService.registerBuyFail(buyBo);
					 model.addAttribute("msg",  AlertMessage.ERR_PAY_P15.resultMessage);
					 return "buy/v2/error"; 
				}	

			}
		}	
	}
	
	
	@RequestMapping(value="periodicBuyReturn", method=RequestMethod.POST)  
	public String periodicBuyReturn(
			  @RequestParam(value="resultcode", required=false) String status
			, @RequestParam(value="resultmsg", required=false) String resultmsg
			, HttpServletRequest request
			, HttpServletResponse response
			 ,Model model) throws Exception {
		
		serviceLog.info("정기 이용권 구입 결과");
		serviceLog.info("resultcode : " +  status);
		serviceLog.info("resultmsg : " +  resultmsg);
		
		BuyBo buyBo = new BuyBo();	
		
		try {
			if(!StringUtils.equals("00", status)) { // 인증키 발급 실패 시
				serviceLog.error("[이니시스 결제 실패] 인증키 발급 실패 ");
				String buyNum = (request.getParameter("orderid") == null) ? "" : request.getParameter("orderid");
				
				if(StringUtils.isBlank(buyNum)) {
					serviceLog.error("[이니시스 결제 실패] 이니시스에서 orderid(buyNum) 정보가 넘어오지 않음 ");
					throw new WebViewRedirectException(AlertMessage.ERR_ETC);
				} else {
					buyBo = buyService.selectTempBuyInfo(buyNum);
					if(buyBo == null) {
						
						buyBo = new BuyBo();
						serviceLog.error("[이니시스 결제 실패] 임시 테이블에 존재하지 않음 ");
						buyBo.setBuyFailReason("[이니시스 결제 실패] 임시 테이블에 존재하지 않음 ");
						buyBo.setBuyType(buyType.BT001.code);
						buyService.registerBuyFail(buyBo);
						 
						throw new WebViewRedirectException(AlertMessage.ERR_ETC);
						
					} else {
						String msg = "[이니시스 정기 결제 실패] / " + MDC.get("traceId") + "/ message : "+  resultmsg + "/ buyNum : " + buyBo.getBuyNum() + ", utilzNum : " + buyBo.getUtilzNum() 
						+", buyTid : " + buyBo.getBuyTid()+ ", buyId : " + buyBo.getBuyId();
						serviceLog.error(msg);
						
						buyBo.setBuyFailReason(msg);
						buyBo.setBuyType(buyType.BT002.code);
						buyService.registerBuyFail(buyBo);
						
						return alertResultPeriodicMessage(model, resultmsg);
					}
				}
			} else { // 인증키 발급 성공시
				serviceLog.info("[이니시스 결제] 인증키 발급 성공");
				
				String buyNum = (request.getParameter("orderid") == null) ? "" : request.getParameter("orderid");
				String billkey = (request.getParameter("billkey") == null) ? "" : request.getParameter("billkey");
				String tid = (request.getParameter("tid") == null) ? "" : request.getParameter("tid");
				String merchantreserved = (request.getParameter("merchantreserved") == null) ? "" : request.getParameter("merchantreserved");
				
				
				serviceLog.info("billkey : " +  billkey);
				serviceLog.info("tid : " +  tid);
				serviceLog.info("pgauthdate/pgauthtime : " + StringUtils.defaultString(request.getParameter("pgauthdate"))+StringUtils.defaultString(request.getParameter("pgauthtime")) );
				serviceLog.info("orderid : " +  StringUtils.defaultIfBlank(request.getParameter("orderid"), "none"));
				serviceLog.info("merchantreserved : " +  merchantreserved);
				
				
				if(StringUtils.isBlank(buyNum)||StringUtils.isBlank(billkey)||StringUtils.isBlank(tid)) {
					serviceLog.error("[이니시스 결제 실패] 이니시스에서 필수 정보가 넘어오지 않음");
					buyBo.setBuyFailReason("[이니시스 결제 실패] 이니시스에서 필수 정보가 넘어오지 않음");
					buyBo.setBuyType(buyType.BT002.code);
					buyService.registerBuyFail(buyBo);
					 
					throw new WebViewRedirectException(AlertMessage.ERR_ETC);
				} 
				serviceLog.info("1. DB에서 결제 정보 가져옴");
				buyBo = buyService.selectTempBuyInfo(buyNum);
				
				if(buyBo == null) {
					buyBo = new BuyBo();
					
					serviceLog.error("[이니시스 결제 실패] 임시 테이블에 존재하지 않음");
					buyBo.setBuyFailReason("[이니시스 결제 실패] 임시 테이블에 존재하지 않음 ");
					buyBo.setBuyType(buyType.BT002.code);
					buyService.registerBuyFail(buyBo);
					 
					throw new WebViewRedirectException(AlertMessage.ERR_ETC);
					
				} else {
					serviceLog.info("2. 이니시스에 받은 값 설정");
					// 이니시스에서 받아와야 하는 값
					buyBo.setResultMessage(resultmsg);
					buyBo.setBuyPeriodicBillingKey(billkey);
					buyBo.setBuyAuthTid(tid);
					buyBo.setAdtUserKey(merchantreserved);
					
					String payDay = StringUtils.defaultString(request.getParameter("pgauthdate"))+StringUtils.defaultString(request.getParameter("pgauthtime"));
					
					if(StringUtils.isBlank(payDay)) {
						payDay = DateFormatUtils.getDateFormat("yyyyMMddHHmmss");
					}
										
					buyBo.setPayDay(payDay);
					buyBo.setFirstBuyNum(Long.parseLong(buyBo.getBuyNum()));
					buyBo.setPayOption(CommonCode.pmmCode.CARD.code);
					
					// 0원 상품 : 중복결제여부 확인
					if(buyBo.getPayPrice() == 0){
						// 기프로모션 여부 조회
						serviceLog.info("3. 해당 결제 건 프로모션 구매 여부 조회");
						if(StringUtils.equals(CommonCode.ppcCode.MELON.code, buyBo.getUtilzAgent())) {
							serviceLog.info("3-1. 멜론일 경우 빌링키 여부 확인");
							buyBo = buyUtils.isMelonNonBillingKeyBuyerPromotionCheck(buyBo);
						} else {
							buyBo.setMelonNonBillingKeyYN("N");
						}
						if(StringUtils.equals(CommonCode.discountDivision.COUPON.code, buyBo.getDiscountDivision())
								&& StringUtils.equals(Constants.YES, buyBo.getDiscountApplyYN())){
							serviceLog.info("3-1. 쿠폰이용권 일 경우 이용권 정보 조회 ");
							BuyBo couponInfo = buyServiceV2.selectBuyUtilz(buyBo.getUtilzNum());
							if(!StringUtils.equals(Constants.MUSICMATE_AGENT_CODE_212190090, couponInfo.getUtilzAgentCode())){
								buyBo.setCouponApplyYN(Constants.YES);
								buyBo.setCouponInputPosition(couponInputPosition.AGENTLIST.code);
							}
						}
						if(buyUtils.selectPromotionDeviceCnt(buyBo)) {
							serviceLog.info("3-1. 이미 해당 프로모션 할인 사용");
							serviceLog.error("3-2. 프로모션 이용권 중복결제로 인한 결제 실패 처리");
							buyBo.setBuyType(CommonCode.buyType.BT002.code);
							buyBo.setBuyFailReason("프로모션 이용권(0원상품) 중복결제로 인한 결제 실패 처리");
							buyService.registerBuyFail(buyBo);
							model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
							return "buy/v2/error"; 
						}
					}
					
					// 임시테이블에서 가져온 결제금액 설정 > 기존 가격설정내용은 삭제 ( 임시테이블 저장 전에 이미 함)
					serviceLog.info("3. 결제금액 설정 및 부가세 계산");
					buyBo = buyUtils.getCalcVatInfo(buyBo); // 부가세 계산
					
					serviceLog.info("3. 재고 확인");
					
					if(!stockCountUtil.decreaseUtilzStock(buyBo.getUtilzNum())) {
						serviceLog.info("3. 재고가 존재하지 않음");
						
						// 재고 수량 감소 실패
						buyBo.setBuyFailReason("[정기결제 재고 감소 실패] / " + MDC.get("traceId") + "/ buyNum : " + buyBo.getBuyNum() 
						+ ", utilzNum : " + buyBo.getUtilzNum() +", buyTid : " + buyBo.getBuyTid()+ ", buyId : " + buyBo.getBuyId() );
						buyBo.setBuyType(buyType.BT002.code);
						buyService.registerBuyFail(buyBo);
						
						model.addAttribute("msg",  AlertMessage.ERR_PAY_P15.resultMessage);
						return "buy/v2/error"; 
						
					} else {
						serviceLog.info("3. 재고 존재-이용권 구매 및 등록");
						buyBo.setAppVersion(20);
						
						if(CommonCode.utilzKindCode.GROUP.code.equals(buyBo.getUtilzKind())) {
							buyBo = buyServiceV2.periodicBuy(buyBo, request);
						}else {
							buyBo = buyService.getPeriodicBuy(buyBo, request);
						}
						
						
						
						
						if(buyBo.getResultPayCount() < 1 ) { // 상품 결제 및 등록 실패
							serviceLog.info("3. 재고 존재-상품 구매 및 등록");
							
							 serviceLog.error("4.이용권 등록 처리 실패");
							 
							 serviceLog.info("4-1. 실패 정보 Db에 저장");
							 buyBo.setBuyType(buyType.BT002.code);
							 buyService.registerBuyFail(buyBo);
							 
							 serviceLog.info("4-2. 재고 수량 증가");
							 stockCountUtil.increaseUtilzStock(buyBo.getUtilzNum());   //  재고 수량 증가
							
							 
							 serviceLog.info("4-3. 0원 이상일 경우 금액 취소");
							 if(buyBo.isPayResult() && buyBo.getPayPrice() > 0) {
								 serviceLog.info("4-3-1. 정기 결제 실패 시, 결제 성공, 금액 존재할 경우 이니시스 취소 처리");
								 buyBo = inicisUtil.getInicisCancelPay(buyBo, request, false);
								 	
								 if(!buyBo.isResultCode()) {
									 serviceLog.error("4-3-2. 정기 결제 실패 시, 결제 취소 처리 중 에러 발생");
									 buyBo.setBuyType(CommonCode.buyType.BT004.code);
									 buyBo.setBuyFailReason("정기 결제 실패 시, 결제 취소 실패");
									 buyService.registerBuyFail(buyBo);
								 }
							 } 
							 
							model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
							return "buy/v2/error";  
							
						} else  {
							String msg = "";
							if(buyBo.getPayPrice() > 0) {  // 0원 상품이 아닐경우
								msg = "결제가 완료되었습니다.";
							} else {
								msg = "이벤트 이용권 결제가 완료되었습니다. <br/>무료 이용기간 종료 후 월 정기결제가 진행됩니다.";
							}
							String url = "";
							
							if(StringUtils.equals(CommonCode.ppcCode.AUDIUN.code, buyBo.getUtilzAgent())) {
								url = UrlConfig.appAudienHomeSchem;
							} else  if (StringUtils.equals(CommonCode.ppcCode.MELON.code, buyBo.getUtilzAgent())) {
								url = UrlConfig.appMelonHomeSchem;
							}  else  if (StringUtils.equals(CommonCode.ppcCode.MUSICMATE.code, buyBo.getUtilzAgent())) {
								url = UrlConfig.appMusicmateHomeSchem;
							}  else  if (StringUtils.equals(CommonCode.ppcCode.BUGS.code, buyBo.getUtilzAgent())) {
								url = UrlConfig.appBugsHomeSchem;
							} else  if (StringUtils.equals(CommonCode.ppcCode.EVERYSING.code, buyBo.getUtilzAgent())) {
								url = UrlConfig.appEverysingHomeSchem;
							} else  if (StringUtils.equals(CommonCode.ppcCode.KUMYOUNG.code, buyBo.getUtilzAgent())) {
								url = UrlConfig.appKumyoungHomeSchem;
							} else  if (StringUtils.equals(CommonCode.ppcCode.OPAL.code, buyBo.getUtilzAgent())) {
								msg = "이제 NUGU opal을 이용하실 수 있습니다.<br/>선택하신 디바이스로 홈컨텐츠와 메뉴가 변경됩니다.";
								url = UrlConfig.appOpalHomeSchem+buyBo.getNuguDeviceSerialNum();
							} else  if (StringUtils.equals(CommonCode.ppcCode.CELEB_VOICE.code, buyBo.getUtilzAgent())) {
								msg = "결제가 완료되었습니다.<br/>‘서비스 이용하기’를 눌러 셀럽의 목소리로 설정해보세요.";
								url = UrlConfig.appCelebVoiceHomeSchem+buyBo.getNuguDeviceSerialNum();
							} else  if (StringUtils.equals(CommonCode.ppcCode.CELEB_ALARM.code, buyBo.getUtilzAgent())) {
								msg = "결제가 완료되었습니다.<br/>‘서비스 이용하기’를 눌러 셀럽의 목소리로 알람을 설정해보세요.";
								url = UrlConfig.appCelebAlarmHomeSchem;
							}
							model.addAttribute("utilzAgent", buyBo.getUtilzAgent());
							model.addAttribute("msg", msg);
							model.addAttribute("redirectionUrl", url);
							serviceLog.info("결과 : msg - " + msg + "/redirectionUrl : " + url);
							return "buy/v2/result"; 
						}						
					}
				}
			}
			
		} catch (Exception e) {
			serviceLog.error("알수 없는 에러 발생 : " + e.getMessage());
			throw new WebViewRedirectException(AlertMessage.ERR_ETC);
		}
	}
	
	
	/**
	 * 멜론 return url
	 * @param request
	 * @param response
	 * @param model
	 * @return
	 * @throws Exception
	 */
	@RequestMapping(value="melonBuyReturn")  
	public String melonReturnUrl(
			 @RequestParam(value="orderid", required=false) String buyNum
			, @RequestParam(value="buyKey", required=false) String buyKey
			, @RequestParam(value="payOption", required=false) String payOption
		, HttpServletRequest request
			, HttpServletResponse response
			, Model model) throws Exception {
		
		try {
			BuyBo buyBo = new BuyBo();	
			
			if(StringUtils.isEmpty(buyNum) || StringUtils.isEmpty(buyKey)) {
				
				serviceLog.error("멜론에서 인증 완료 후 필수 파라미터를 넘겨주지 않음");
				model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
				return "buy/v2/error";  
				
			} else {
				buyBo = buyService.selectTempBuyInfo(buyNum);
				
					if(buyBo != null) {
						
						String _buyKey = SecurityUtils.encryptPassword(buyBo.getBuyNum(), buyBo.getxAldAccessToken());
						serviceLog.info("buyKey : " + _buyKey);
						
						// 인증 키 유효성 확인
						if(!StringUtils.equals(buyKey, _buyKey)) {
							serviceLog.error("멜론에서 인증 완료 후 인증키 정보가 맞지 않음");
							model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
							return "buy/v2/error";  
						} else {
								int payPrice =  buyBo.getListPrice();
							
								if(StringUtils.equals("Y", buyBo.getDiscountApplyYN())) {
									if(StringUtils.equals(CommonCode.discountDivision.COUPON.code, buyBo.getDiscountDivision())) {
										payPrice = 0;
									} else if(StringUtils.equals(CommonCode.discountDivision.PROMOTION.code, buyBo.getDiscountDivision())
											&& !StringUtils.equals("Y",buyBo.getUsedPromotionYN())) {
										payPrice = buyBo.getSalePrice();
									} else if(StringUtils.equals(CommonCode.discountDivision.TMEMBERSHIP.code, buyBo.getDiscountDivision())) {
										payPrice = buyBo.gettMembershipSaleprice();
									}
								}
								
								buyBo.setPayPrice(payPrice);
								buyBo = buyUtils.getCalcVatInfo(buyBo);
								model.addAttribute("buy", buyBo); 
								
								if(StringUtils.equals("Y", buyBo.getPeriodicYN())) { // 정기
									
									String timestamp = DateFormatUtils.getDateFormat("yyyyMMddHHmmss");
									String url = "";
									
									model.addAttribute("inicisUrl", UrlConfig.billingCardUrl);
									model.addAttribute("periodInicisKey", periodInicisKey);
									model.addAttribute("timestamp", timestamp);
									model.addAttribute("merchantkey", UrlConfig.inicisMerchantkey);
									model.addAttribute("period", "M2");
									model.addAttribute("periodReturnUrl", UrlConfig.periodReturnUrlV2);
														
									String data = periodInicisKey+buyBo.getBuyNum()+timestamp+UrlConfig.inicisMerchantkey;
									
									try {
										
										model.addAttribute("hashdata", SecurityUtils.makeHashdata(data));
										serviceLog.info("url"+url);									
										serviceLog.info("param:mid="+periodInicisKey+",buyername="+buyBo.getUtilzName()
										+",goodname="+buyBo.getUtilzName()+",price="+buyBo.getPayPrice()+",orderid="+buyBo.getBuyNum()
										+",type=1,timestamp"+timestamp+",period=M2+,notice=결제 완료 되었습니다.,P_CHARSET=utf8,hashdata:"+SecurityUtils.makeHashdata(data)
										+",merchantkey="+UrlConfig.inicisMerchantkey+",p_noti="+",returnurl="+UrlConfig.periodReturnUrlV2);
										return "buy/periodicReturn";
									
									} catch (Exception e) {
										serviceLog.error("정기 결제 페이지 요청 error :" + e.getMessage());
										model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
										return "buy/v2/error";  
									} 
								} else { // 단품
									
									// 상세 페이지 및 결제에 필요한 정보 등록
									model.addAttribute("inicisUrl", UrlConfig.singleCardUrl);
									model.addAttribute("singleInicisKey", singleInicisKey);
									model.addAttribute("singleReturnUrl", UrlConfig.singleReturnUrlV2);
									model.addAttribute("version", "v2");
									
									serviceLog.info("url"+UrlConfig.singleCardUrl);																	
									return "buy/singleReturn";
								}
							}
					} else {
						serviceLog.error("임시 데이터 없음");
						model.addAttribute("msg",  AlertMessage.ERR_PAY.resultMessage);
						return "buy/v2/error";  
				}
			}
		} catch(Exception e) {
			serviceLog.error("알수 없는 에러 발생 : " + e.getMessage());
			throw new RedirectException(AlertMessage.ERR_ETC);
		}
	}
	
	
	public String alertResultPeriodicMessage(Model model, String resultmsg) {
		
		String msg = "";
		
		// 결과 문구 노출
		if((resultmsg.indexOf("1201") > -1) || (resultmsg.indexOf("12FX") > -1) || (resultmsg.indexOf("00FX") > -1)) {
			msg = AlertMessage.ERR_PAY_P01.resultMessage;
		}  else if ((resultmsg.indexOf("00AA") > -1) || (resultmsg.indexOf("00FY") > -1) || (resultmsg.indexOf("12AA") > -1) || (resultmsg.indexOf("12FY") > -1)
				|| (resultmsg.indexOf("0016") > -1) || (resultmsg.indexOf("00FN") > -1) || (resultmsg.indexOf("00G6") > -1) || (resultmsg.indexOf("00GG") > -1)
				|| (resultmsg.indexOf("00GH") > -1) || (resultmsg.indexOf("00GI") > -1) || (resultmsg.indexOf("00GT") > -1) || (resultmsg.indexOf("00K9") > -1)
				|| (resultmsg.indexOf("1216") > -1) || (resultmsg.indexOf("12FN") > -1) || (resultmsg.indexOf("12G6") > -1) || (resultmsg.indexOf("12GG") > -1)
				|| (resultmsg.indexOf("12GH") > -1) || (resultmsg.indexOf("12GI") > -1) || (resultmsg.indexOf("12GT") > -1) || (resultmsg.indexOf("12K9") > -1)
				|| (resultmsg.indexOf("0786") > -1)) { 
			msg = AlertMessage.ERR_PAY_P03.resultMessage;
		} else if (resultmsg.indexOf("12F1") > -1) {
			msg = AlertMessage.ERR_PAY_P04.resultMessage;
		} else if (resultmsg.indexOf("1221") > -1) {
			msg = AlertMessage.ERR_PAY_P05.resultMessage;
		} else if (resultmsg.indexOf("1223") > -1  || (resultmsg.indexOf("1165") > -1)) {
			msg = AlertMessage.ERR_PAY_P06.resultMessage;
		} else if ((resultmsg.indexOf("1214") > -1) || (resultmsg.indexOf("1160") > -1)) {
			msg = AlertMessage.ERR_PAY_P07.resultMessage;
		} else if (resultmsg.indexOf("1226") > -1) {
			msg = AlertMessage.ERR_PAY_P08.resultMessage;
		} else if (resultmsg.indexOf("1227") > -1) {
			msg = AlertMessage.ERR_PAY_P09.resultMessage;
		} else if (resultmsg.indexOf("1237") > -1) {
			msg = AlertMessage.ERR_PAY_P10.resultMessage;
		} else if (resultmsg.indexOf("1251") > -1) {
			msg = AlertMessage.ERR_PAY_P11.resultMessage;
		} else if ((resultmsg.indexOf("1252") > -1) || (resultmsg.indexOf("1184") > -1)) {
			msg = AlertMessage.ERR_PAY_P11.resultMessage;
		} else if (resultmsg.indexOf("1254") > -1) {
			msg = AlertMessage.ERR_PAY_P12.resultMessage;
		} else if (resultmsg.indexOf("1219") > -1) {
			msg = AlertMessage.ERR_PAY_P14.resultMessage;
		} else {
			msg = AlertMessage.ERR_PAY.resultMessage;
		}
		model.addAttribute("msg",  msg);
		serviceLog.info("결제 실패 메세지: " + msg);
		
		return "buy/v2/error"; 
	}
	
	/**
	 * 단건 error Code별 처리
	 * @param model
	 * @param status
	 */
	public String alertResultSingleMessage(Model model, String status) {

		String msg = "";
		
		// error code 별 alert
		if(StringUtils.contains(status, "00FW") || StringUtils.contains(status, "00FX") || StringUtils.contains(status, "12FX")) {
			msg = AlertMessage.ERR_PAY_P01.resultMessage;
		} else if ((StringUtils.contains(status, "00AA")) || (StringUtils.contains(status, "00FY")) || (StringUtils.contains(status, "12AA")) || (StringUtils.contains(status, "12FY"))
				|| (StringUtils.contains(status, "0016")) || (StringUtils.contains(status, "00FN")) || (StringUtils.contains(status, "00G6")) || (StringUtils.contains(status, "00GG"))
				|| (StringUtils.contains(status, "00GH")) || (StringUtils.contains(status, "00GI")) || (StringUtils.contains(status, "00GT")) || (StringUtils.contains(status, "00K9"))
				|| (StringUtils.contains(status, "1216")) || (StringUtils.contains(status, "12FN")) || (StringUtils.contains(status, "12G6")) || (StringUtils.contains(status, "12GG"))
				|| (StringUtils.contains(status, "12GH")) || (StringUtils.contains(status, "12GI")) || (StringUtils.contains(status, "12GT")) || (StringUtils.contains(status, "12K9"))
				|| (StringUtils.contains(status, "0786"))) {
			msg = AlertMessage.ERR_PAY_P03.resultMessage;
		} else if(StringUtils.contains(status, "00F1")) {
			msg = AlertMessage.ERR_PAY_P04.resultMessage;
		} else if(StringUtils.contains(status, "0021")) {
			msg = AlertMessage.ERR_PAY_P05.resultMessage;
		} else if(StringUtils.contains(status, "0054")) {
			msg = AlertMessage.ERR_PAY_P12.resultMessage;
		} else if(StringUtils.contains(status, "0048")) {
			msg = AlertMessage.ERR_PAY_P13.resultMessage;
		} else if(StringUtils.contains(status, "0026")) {
			msg = AlertMessage.ERR_PAY_P08.resultMessage;
		} else if(StringUtils.contains(status, "0023")) {
			msg = AlertMessage.ERR_PAY_P06.resultMessage;
		} else if(StringUtils.contains(status, "0051")) {
			msg = AlertMessage.ERR_PAY_P11.resultMessage;
		} else if(StringUtils.contains(status, "0039")){
			msg = AlertMessage.ERR_PAY_P10.resultMessage;
		} else if(StringUtils.contains(status, "0019")){
			msg = AlertMessage.ERR_PAY_P14.resultMessage;;
		} else { 
			msg = AlertMessage.ERR_PAY.resultMessage;
		}
		model.addAttribute("msg",  msg);
		serviceLog.info("결제 실패 메세지: " + msg);
		return "buy/v2/error";
	}
	
	
	@RequestMapping(value="billKeyChangeReturn", method=RequestMethod.POST)  
	public String billKeyChangeReturn(
			  @RequestParam(value="resultcode", required=false) String status
			, @RequestParam(value="resultmsg", required=false) String resultmsg
			, HttpServletRequest request
			, HttpServletResponse response
			 ,Model model) throws Exception {
		
		serviceLog.info("카드 빌키 변경 결과");
		serviceLog.info("resultcode : " +  status);
		serviceLog.info("resultmsg : " +  resultmsg);
		
		BuyBo buyBo = new BuyBo();	
		
		try {
			if(!StringUtils.equals("00", status)) { // 인증키 발급 실패 시
				serviceLog.error("[이니시스 빌키 발급 실패] 인증키 발급 실패 ");
				String buyNum = (request.getParameter("orderid") == null) ? "" : request.getParameter("orderid");
				serviceLog.error("[이니시스 빌키 발급 실패 buyNum] " +buyNum);
				
				if(StringUtils.isBlank(buyNum)) {
					serviceLog.error("[이니시스 빌키 발급 실패] 이니시스에서 orderid(buyNum) 정보가 넘어오지 않음 ");
					throw new WebViewRedirectException(AlertMessage.ERR_ETC);
				}else{
					String msg = "[이니시스 빌키 발급 실패] / " + MDC.get("traceId") + "/ message : "+  resultmsg + "/ buyNum : " + buyBo.getBuyNum() + ", utilzNum : " + buyBo.getUtilzNum() 
					+", buyTid : " + buyBo.getBuyTid()+ ", buyId : " + buyBo.getBuyId();
					serviceLog.error(msg);
					return alertResultPeriodicMessage(model, resultmsg);
				}
			} else { // 인증키 발급 성공시
				serviceLog.info("[이니시스 빌키 발급] 성공");
				
				String buyNum = (request.getParameter("orderid") == null) ? "" : request.getParameter("orderid");
				String billkey = (request.getParameter("billkey") == null) ? "" : request.getParameter("billkey");
				String tid = (request.getParameter("tid") == null) ? "" : request.getParameter("tid");
				String merchantreserved = (request.getParameter("merchantreserved") == null) ? "" : request.getParameter("merchantreserved");
				
				
				serviceLog.info("billkey : " +  billkey);
				serviceLog.info("tid : " +  tid);
				serviceLog.info("pgauthdate/pgauthtime : " + StringUtils.defaultString(request.getParameter("pgauthdate"))+StringUtils.defaultString(request.getParameter("pgauthtime")) );
				serviceLog.info("orderid : " +  StringUtils.defaultIfBlank(request.getParameter("orderid"), "none"));
				serviceLog.info("merchantreserved : " +  merchantreserved);
				
				
				if(StringUtils.isBlank(buyNum)||StringUtils.isBlank(billkey)||StringUtils.isBlank(tid)) {
					serviceLog.error("[이니시스 빌키 발급 실패] 이니시스에서 필수 정보가 넘어오지 않음");
					throw new WebViewRedirectException(AlertMessage.ERR_ETC);
				} 
				
				buyBo = buyService.selectBuyBo(buyNum);
				
				if(buyBo == null){
					serviceLog.error("[이니시스 빌키 발급 실패] DB 정보 없음 buyNum : "+buyNum);
					throw new WebViewRedirectException(AlertMessage.ERR_ETC);
				}

				// billkey 업데이트
				buyBo.setBuyPeriodicBillingKey(billkey);
				buyService.updateBillKey(buyBo);

				String msg = "카드 변경이 완료되었습니다.";
				String url = "";
				
				if(StringUtils.equals(CommonCode.ppcCode.AUDIUN.code, buyBo.getUtilzAgent())) {
					url = UrlConfig.appAudienHomeSchem;
				} else  if (StringUtils.equals(CommonCode.ppcCode.MELON.code, buyBo.getUtilzAgent())) {
					url = UrlConfig.appMelonHomeSchem;
				}  else  if (StringUtils.equals(CommonCode.ppcCode.MUSICMATE.code, buyBo.getUtilzAgent())) {
					url = UrlConfig.appMusicmateHomeSchem;
				}  else  if (StringUtils.equals(CommonCode.ppcCode.BUGS.code, buyBo.getUtilzAgent())) {
					url = UrlConfig.appBugsHomeSchem;
				} else  if (StringUtils.equals(CommonCode.ppcCode.EVERYSING.code, buyBo.getUtilzAgent())) {
					url = UrlConfig.appEverysingHomeSchem;
				} else  if (StringUtils.equals(CommonCode.ppcCode.KUMYOUNG.code, buyBo.getUtilzAgent())) {
					url = UrlConfig.appKumyoungHomeSchem;
				} else  if (StringUtils.equals(CommonCode.ppcCode.OPAL.code, buyBo.getUtilzAgent())) {
					model.addAttribute("utilzAgent", CommonCode.ppcCode.OPAL.code);
					//msg = "이제 NUGU opal을 이용하실 수 있습니다.<br/>선택하신 디바이스로 홈컨텐츠와 메뉴가 변경됩니다.";
					url = UrlConfig.appOpalHomeSchem+buyBo.getNuguDeviceSerialNum();
				} else  if (StringUtils.equals(CommonCode.ppcCode.CELEB_VOICE.code, buyBo.getUtilzAgent())) {
					url = UrlConfig.appCelebVoiceHomeSchem;
				} else  if (StringUtils.equals(CommonCode.ppcCode.CELEB_ALARM.code, buyBo.getUtilzAgent())) {
					url = UrlConfig.appCelebAlarmHomeSchem;
				}
				model.addAttribute("msg", msg);
				model.addAttribute("redirectionUrl", url);
				serviceLog.info("결과 : msg - " + msg + "/redirectionUrl : " + url);
				return "buy/v2/billKeyChangeResult"; 

			}
			
		} catch (Exception e) {
			serviceLog.error("알수 없는 에러 발생 : " + e.getMessage());
			throw new WebViewRedirectException(AlertMessage.ERR_ETC);
		}
	}
}
```






